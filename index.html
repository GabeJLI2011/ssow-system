<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health & Safety Document Signing System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body style="margin:0;">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Icon components (inline SVG)
        const Icons = {
            FileText: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            CheckCircle: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Clock: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            User: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
            LogOut: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
            Plus: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            Trash2: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Edit: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
            Users: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Eye: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            EyeOff: ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
        };

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [documents, setDocuments] = useState([]);
            const [employees, setEmployees] = useState([]);
            const [selectedDoc, setSelectedDoc] = useState(null);
            const [viewMode, setViewMode] = useState('list');
            const [isAdmin, setIsAdmin] = useState(false);
            
            const [newDocTitle, setNewDocTitle] = useState('');
            const [editingDocId, setEditingDocId] = useState(null);
            const [documentImages, setDocumentImages] = useState([]);
            const contentEditableRef = useRef(null);
            
            const [newEmployeeName, setNewEmployeeName] = useState('');
            const [newEmployeeUsername, setNewEmployeeUsername] = useState('');
            const [newEmployeePassword, setNewEmployeePassword] = useState('');
            const [newEmployeeDepartment, setNewEmployeeDepartment] = useState('');
            const [editingEmployeeId, setEditingEmployeeId] = useState(null);
            const [selectedEmployeePermissions, setSelectedEmployeePermissions] = useState([]);
            
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [signatureData, setSignatureData] = useState(null);
            const [showSignaturePad, setShowSignaturePad] = useState(false);

            useEffect(() => {
                loadData();
            }, []);

            const loadData = () => {
                try {
                    const docsData = localStorage.getItem('ssow-documents');
                    if (docsData) {
                        const loadedDocs = JSON.parse(docsData);
                        setDocuments(loadedDocs.map(doc => ({
                            ...doc,
                            images: doc.images || [],
                            signatures: doc.signatures || []
                        })));
                    }

                    const employeesData = localStorage.getItem('ssow-employees');
                    if (employeesData) {
                        setEmployees(JSON.parse(employeesData));
                    } else {
                        const defaultEmployees = [{
                            id: 'emp1',
                            name: 'Administrator',
                            username: 'admin',
                            password: 'admin123',
                            department: 'Management',
                            isAdmin: true,
                            permissions: []
                        }];
                        localStorage.setItem('ssow-employees', JSON.stringify(defaultEmployees));
                        setEmployees(defaultEmployees);
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            };

            const saveDocuments = (updatedDocs) => {
                try {
                    localStorage.setItem('ssow-documents', JSON.stringify(updatedDocs));
                    setDocuments(updatedDocs);
                } catch (error) {
                    console.error('Error saving documents:', error);
                    alert('Error saving document');
                }
            };

            const saveEmployees = (updatedEmployees) => {
                try {
                    localStorage.setItem('ssow-employees', JSON.stringify(updatedEmployees));
                    setEmployees(updatedEmployees);
                } catch (error) {
                    console.error('Error saving employees:', error);
                    alert('Error saving employee');
                }
            };

            const handleLogin = () => {
                const employee = employees.find(emp => 
                    emp.username === username && emp.password === password
                );
                
                if (employee) {
                    setCurrentUser(employee);
                    setIsAdmin(employee.isAdmin || false);
                    setUsername('');
                    setPassword('');
                } else {
                    alert('Invalid username or password');
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setIsAdmin(false);
                setSelectedDoc(null);
                setViewMode('list');
            };

            const handleSignDocument = () => {
                if (!signatureData) {
                    alert('Please draw your signature first');
                    return;
                }

                const signature = {
                    userName: currentUser.name,
                    userId: currentUser.id,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleString(),
                    signatureImage: signatureData
                };

                const updatedDocs = documents.map(doc => {
                    if (doc.id === selectedDoc.id) {
                        return {...doc, signatures: [...doc.signatures, signature]};
                    }
                    return doc;
                });

                saveDocuments(updatedDocs);
                setSelectedDoc(null);
                setSignatureData(null);
                setShowSignaturePad(false);
                setViewMode('list');
            };

            const getContentHTML = () => contentEditableRef.current?.innerHTML || '';
            const setContentHTML = (html) => {
                if (contentEditableRef.current) contentEditableRef.current.innerHTML = html;
            };

            const handleAddDocument = () => {
                const contentHTML = getContentHTML();
                const contentText = contentEditableRef.current?.innerText || '';
                
                if (!newDocTitle.trim() || !contentText.trim()) {
                    alert('Please fill in both title and content');
                    return;
                }

                const newDoc = {
                    id: 'doc' + Date.now(),
                    title: newDocTitle.trim(),
                    content: contentHTML,
                    images: documentImages,
                    signatures: []
                };

                saveDocuments([...documents, newDoc]);
                setNewDocTitle('');
                setContentHTML('');
                setDocumentImages([]);
                setViewMode('list');
                alert('Document added successfully!');
            };

            const handleEditDocument = () => {
                const contentHTML = getContentHTML();
                const contentText = contentEditableRef.current?.innerText || '';
                
                if (!newDocTitle.trim() || !contentText.trim()) {
                    alert('Please fill in both title and content');
                    return;
                }

                const updatedDocs = documents.map(doc => {
                    if (doc.id === editingDocId) {
                        return {...doc, title: newDocTitle.trim(), content: contentHTML, images: documentImages};
                    }
                    return doc;
                });

                saveDocuments(updatedDocs);
                setNewDocTitle('');
                setContentHTML('');
                setDocumentImages([]);
                setEditingDocId(null);
                setViewMode('list');
                alert('Document updated successfully!');
            };

            const handleDeleteDocument = (docId) => {
                if (window.confirm('Are you sure you want to delete this document?')) {
                    saveDocuments(documents.filter(doc => doc.id !== docId));
                    if (selectedDoc?.id === docId) {
                        setSelectedDoc(null);
                        setViewMode('list');
                    }
                    alert('Document deleted!');
                }
            };

            const startEditDocument = (doc) => {
                setEditingDocId(doc.id);
                setNewDocTitle(doc.title);
                setDocumentImages(doc.images || []);
                setViewMode('add-document');
                setTimeout(() => setContentHTML(doc.content || ''), 100);
            };

            const handleAddEmployee = () => {
                if (!newEmployeeName.trim() || !newEmployeeUsername.trim() || !newEmployeePassword.trim()) {
                    alert('Please fill in all required fields');
                    return;
                }

                if (employees.some(emp => emp.username === newEmployeeUsername.trim())) {
                    alert('Username already exists');
                    return;
                }

                const newEmployee = {
                    id: 'emp' + Date.now(),
                    name: newEmployeeName.trim(),
                    username: newEmployeeUsername.trim(),
                    password: newEmployeePassword.trim(),
                    department: newEmployeeDepartment.trim(),
                    isAdmin: false,
                    permissions: selectedEmployeePermissions
                };

                saveEmployees([...employees, newEmployee]);
                setNewEmployeeName('');
                setNewEmployeeUsername('');
                setNewEmployeePassword('');
                setNewEmployeeDepartment('');
                setSelectedEmployeePermissions([]);
                setViewMode('list');
                alert('Employee added!');
            };

            const handleEditEmployee = () => {
                if (!newEmployeeName.trim() || !newEmployeeUsername.trim()) {
                    alert('Please fill in all required fields');
                    return;
                }

                const updatedEmployees = employees.map(emp => {
                    if (emp.id === editingEmployeeId) {
                        return {
                            ...emp,
                            name: newEmployeeName.trim(),
                            username: newEmployeeUsername.trim(),
                            password: newEmployeePassword.trim() || emp.password,
                            department: newEmployeeDepartment.trim(),
                            permissions: selectedEmployeePermissions
                        };
                    }
                    return emp;
                });

                saveEmployees(updatedEmployees);
                setNewEmployeeName('');
                setNewEmployeeUsername('');
                setNewEmployeePassword('');
                setNewEmployeeDepartment('');
                setSelectedEmployeePermissions([]);
                setEditingEmployeeId(null);
                setViewMode('list');
                alert('Employee updated!');
            };

            const handleDeleteEmployee = (empId) => {
                const emp = employees.find(e => e.id === empId);
                if (emp?.isAdmin) {
                    alert('Cannot delete admin account');
                    return;
                }
                if (window.confirm('Delete this employee?')) {
                    saveEmployees(employees.filter(e => e.id !== empId));
                    alert('Employee deleted!');
                }
            };

            const startEditEmployee = (emp) => {
                setEditingEmployeeId(emp.id);
                setNewEmployeeName(emp.name);
                setNewEmployeeUsername(emp.username);
                setNewEmployeePassword('');
                setNewEmployeeDepartment(emp.department || '');
                setSelectedEmployeePermissions(emp.permissions || []);
                setViewMode('add-employee');
            };

            const togglePermission = (docId) => {
                setSelectedEmployeePermissions(prev => 
                    prev.includes(docId) ? prev.filter(id => id !== docId) : [...prev, docId]
                );
            };

            const hasUserSigned = (doc) => doc.signatures.some(sig => sig.userId === currentUser.id);
            
            const canUserAccessDocument = (doc) => {
                if (isAdmin) return true;
                if (!currentUser.permissions || currentUser.permissions.length === 0) return true;
                return currentUser.permissions.includes(doc.id);
            };

            const getAccessibleDocuments = () => documents.filter(canUserAccessDocument);

            // Signature pad functions
            const getCoordinates = (e, canvas) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                let clientX, clientY;
                if (e.touches?.[0]) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            };

            const startDrawing = (e) => {
                const canvas = canvasRef.current;
                const { x, y } = getCoordinates(e, canvas);
                const ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const canvas = canvasRef.current;
                const { x, y } = getCoordinates(e, canvas);
                const ctx = canvas.getContext('2d');
                ctx.lineTo(x, y);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
            };

            const stopDrawing = () => {
                if (isDrawing) {
                    setIsDrawing(false);
                    setSignatureData(canvasRef.current.toDataURL());
                }
            };

            const clearSignature = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                setSignatureData(null);
            };

            const handleImageUpload = (e) => {
                Array.from(e.target.files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            setDocumentImages(prev => [...prev, {
                                id: Date.now() + Math.random(),
                                data: event.target.result,
                                name: file.name
                            }]);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };

            const removeImage = (imageId) => {
                setDocumentImages(prev => prev.filter(img => img.id !== imageId));
            };

            const applyFormat = (command, value = null) => {
                document.execCommand(command, false, value);
                contentEditableRef.current?.focus();
            };

            // LOGIN SCREEN
            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <div className="text-center mb-8">
                                <Icons.FileText className="w-16 h-16 text-indigo-600 mx-auto mb-4" />
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">Health & Safety</h1>
                                <p className="text-gray-600">Document Signing System</p>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                    <input
                                        type="text"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                        placeholder="Enter username"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                    <div className="relative">
                                        <input
                                            type={showPassword ? "text" : "password"}
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                            placeholder="Enter password"
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        />
                                        <button
                                            type="button"
                                            onClick={() => setShowPassword(!showPassword)}
                                            className="absolute right-3 top-1/2 -translate-y-1/2"
                                        >
                                            {showPassword ? <Icons.EyeOff className="w-5 h-5 text-gray-500" /> : <Icons.Eye className="w-5 h-5 text-gray-500" />}
                                        </button>
                                    </div>
                                </div>
                                <button
                                    onClick={handleLogin}
                                    disabled={!username.trim() || !password.trim()}
                                    className="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 disabled:bg-gray-300"
                                >
                                    Sign In
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // MAIN APP (simplified for space - showing structure)
            const accessibleDocs = getAccessibleDocuments();

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-bold">Health & Safety Documents</h1>
                                <p className="text-sm text-gray-600">Signed in as {currentUser.name} {isAdmin && '(Admin)'}</p>
                            </div>
                            <div className="flex gap-3">
                                {isAdmin && (
                                    <>
                                        <button onClick={() => setViewMode('manage-employees')} className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg">
                                            <Icons.Users className="w-4 h-4" /> Employees
                                        </button>
                                        <button onClick={() => setViewMode('add-document')} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg">
                                            <Icons.Plus className="w-4 h-4" /> Add Document
                                        </button>
                                    </>
                                )}
                                <button onClick={() => setViewMode('admin')} className="text-indigo-600">View Signatures</button>
                                <button onClick={handleLogout} className="flex items-center gap-2"><Icons.LogOut className="w-4 h-4" /> Logout</button>
                            </div>
                        </div>
                    </div>
                    <div className="max-w-6xl mx-auto p-4">
                        <div className="grid gap-4 md:grid-cols-3">
                            {accessibleDocs.map(doc => {
                                const signed = hasUserSigned(doc);
                                return (
                                    <div key={doc.id} className="bg-white rounded-lg shadow p-6 cursor-pointer relative" onClick={() => {setSelectedDoc(doc); setViewMode('document');}}>
                                        <div className="flex items-start justify-between mb-4">
                                            <Icons.FileText className="w-8 h-8 text-indigo-600" />
                                            {signed && <Icons.CheckCircle className="w-6 h-6 text-green-500" />}
                                        </div>
                                        <h3 className="font-bold mb-2">{doc.title}</h3>
                                        <div className="text-sm text-gray-600 mb-4">{doc.signatures.length} signatures</div>
                                        <div className={`text-sm font-medium ${signed ? 'text-green-600' : 'text-amber-600'}`}>
                                            {signed ? 'âœ“ Signed' : 'Pending'}
                                        </div>
                                        {isAdmin && (
                                            <div className="absolute top-2 right-2 flex gap-2">
                                                <button onClick={(e) => {e.stopPropagation(); startEditDocument(doc);}} className="p-2 bg-blue-50 text-blue-600 rounded"><Icons.Edit className="w-4 h-4" /></button>
                                                <button onClick={(e) => {e.stopPropagation(); handleDeleteDocument(doc.id);}} className="p-2 bg-red-50 text-red-600 rounded"><Icons.Trash2 className="w-4 h-4" /></button>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
